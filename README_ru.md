[![](https://img.shields.io/pypi/v/foliantcontrib.includes.svg)](https://pypi.org/project/foliantcontrib.includes/) [![](https://img.shields.io/github/v/tag/foliant-docs/foliantcontrib.includes.svg?label=GitHub)](https://github.com/foliant-docs/foliantcontrib.includes)

# Препроцессор Includes для Foliant

## Назначение

Препроцессор `Includes` позволяет использовать части других документов или документы целиком в вашем проекте, как из файлов на локальном компьютере, так и из удаленных Git репозиториев. Можно включать целые документы, а также части между определенными заголовками, удаляя или нормализуя включенные заголовки в процессе написания документа.

## Установка

```shell
$ pip install foliantcontrib.includes
```

## Настройка

Для подключения препроцессора добавьте опцию `includes` в секцию `preprocessors` в файл настроек проекта `foliant.yml`.

```yaml
preprocessors:
    - includes
```

### Параметры препроцессора

```yaml
preprocessors:
    - includes:
        cache_dir: !path .includescache
        recursive: true
        error_message: true
        extensions:
            - md
            - j2
        aliases:
            ...
```

`cache_dir`
:   Путь к директории для клонирования Git репозитория. Это может быть относительный или абсолютный путь проекта.
    Для краткости можно использовать `~/`.

> **Примечание**
>
> Чтобы включить файлы из удаленных репозиториев, препроцессор клонирует репозитории в директорию, указанную в параметре.
> Для экономии времени сборки проекта, клонированные репозитории сохраняются и повторно используются при следующих сборках.

`recursive`
:   Параметр определяет, следует ли обрабатывать включения во включенных документах.

`stub_text`
:   Параметр определяет, вставлять или нет сообщение об ошибке добавления контента из включаемого файла в текст документа.
По умолчанию установлен в `true`.

`extensions`
:   Список расширений файлов, определяющий типы файлов, которые должны быть обработаны при поиске инструкций `include`.
 Используется, если нужно включить некоторый контент из сторонних не markodown источников в свои файлы, такие как конфигурации, шаблоны, отчеты и т.д.
 Значение по умолчанию равно `[md]`.

`aliases`
:   Сопоставление псевдонимов с URL-адресами репозитория Git. После определения этого параметра псевдоним может использоваться для ссылки на репозиторий вместо его полного URL-адреса.

>**Внимание!**
>
> Псевдонимы доступны только в рамках устаревшего синтаксиса инструкций include (см. ниже)
>
> Например, если необходимо установить псевдоним в конфигурационном файле:
>
>```yml
>    - includes:
>        aliases:
>           foo: https://github.com/boo/bar.git
>           baz: https://github.com/foo/far.git#develop
>```
>
>Чтобы включить контент из файла `doc.md` в этих репозиториях, используйте следующий синтаксис:
>
>``` markdown
>
>    <include>$foo$path/to/doc.md</include>
>
>   <include>$baz#master$path/to/doc.md</include>
>```
>
>Обратите внимание, что во втором примере ветка `develop` будет заменена на `master`.

## Синтаксис препроцессора

Препроцессор допускает два варианта синтаксиса для инструкций `include`

**Устаревший** синтаксис проще и короче, но менее гибок.
Развитие данного синтаксиса не предполагается.

**Новый** синтаксис, введенный в версии 1.1.0, является более строгим и гибким.
Он больше подходит для сложных случаев, и его можно легко расширить в будущем.
Это предпочтительный синтаксис.

Оба варианта используют теги `<include></include>`.

Если включаемый файл указан между тегами, это устаревший синтаксис. Если на файл есть ссылка в атрибутах тега (`src`, `repo_url`, `path`), это новый синтаксис.

### Использование нового синтаксиса инструкций includes

Для включения нужного контента, укажите его в атрибутах тега `<include></include>`

#### Атрибуты

1. `src`

   Путь к локальному файлу, который нужно включить.

   **Пример:**

   ```markdown
   Приведенный ниже текст взят из другого документа.

   <include src="path/to/another/document.md"></include>
   ```

2. `url`

   HTTP(S) URL контента, который должен быть включён.

    **Пример:**

    ```markdown
    Приведенный ниже текст взят из удаленного репозитория в ветке по умолчанию.

    <include url="https://github.com/foo/bar/path/to/doc.md"></include>
    ```

    > **Примечание**
    >
    > Для проектов, расположенных в GitHub, необходимо указать полный путь к raw-файлу, не указывая при этом расширение файла `.md`.
    >
    >  ``` markdown
    >   <include url="https://github.com/path/to/doc/raw/master/doc" nohead="true"></include>
    >   ```
    >
    > Для проектов, расположенных в GitLab, необходимо указать полный путь к raw-файлу и указать расширение файла `.md`.
    >
    >    ```markdown
    >    <include url="https://gitlub.com/path/to/doc/raw/master/doc.md" nohead="true"></include>
    >    ```

3. `repo_url`

   Полный URL удаленного репозитория Git без изменений.

   `path`

   Путь к файлу внутри удаленного репозитория Git.
   Необходимо знать полный URL для удаленного репозитория, так как `aliases` здесь не поддерживаются.

    >**Примечание**
    >
    >`path` - обязательный параметр при использовании `repo_url`! Его отсутствие приведёт к некорректной работе препроцессора.

    **Пример:**

    ```markdown
    Text below is taken from a remote repository.

    <include repo_url="https://github.com/foo/bar.git" path="path/to/doc.md"></include>
    ```

#### Дополнительные атрибуты

> **Примечание:**
>
> Foliant 1.0.9 поддерживает обработку значений атрибутов в формате YAML. Можно предварять значения атрибутов модификаторами `!path`, `!project_path` и `!rel_path` (т.е. тегами YAML). Эти модификаторы могут быть полезны в атрибутах `src`, `path` и `project_root`.

1. `revision`

   Ветка в Git репозитории.

    **Пример:**

    ```markdown
    Приведенный ниже текст взят из удаленного репозитория с ветки `develop`.

    <include repo_url="https://github.com/foo/bar.git" revision="develop" path="path/to/doc.md"></include>
    ```

2. `from_heading`

   Полное содержимое начального заголовка, если необходимо включить некоторую часть содержимого файла, на который дана ссылка. Если атрибуты `to_heading`, `to_id` или `to_end` не указаны, препроцессор сокращает включенное содержимое до следующего заголовка того же уровня.

   *Заголовок, на который дана ссылка, тоже включается.*

3. `to_heading`

   Полное содержимое конечного заголовка, если необходимо включить некоторую часть содержимого файла, на который дана ссылка.

   *Заголовок, на который дана ссылка, не включается.*

4. `from_id`

   Идентификатор начального заголовка или начальной привязки, когда необходимо включить некоторую часть содержимого файла, на который указывает ссылка.
   Атрибут `from_id` имеет более высокий приоритет, чем `from_heading`.
   Если атрибуты `to_heading`, `to_id` или `to_end` не указаны, препроцессор сокращает включенное содержимое до следующего заголовка того же уровня.

   *Указанный идентификатор включается.*

5. `to_id`

   Идентификатор конечного заголовка или конечной привязки, когда необходимо включить некоторую часть содержимого файла, на который указывает ссылка. Атрибут `to_id` имеет более высокий приоритет, чем `to_heading`.

   *Идентификатор не будет включен.*

    > **Примечание:**
    >
    > Если вы хотите, чтобы функции `from_id` и `to_id` работали с [anchors](https://foliant-docs.github.io/docs/preprocessors/anchors/) (якорями), убедитесь, что препроцессор anchors  указан *после* includes в foliant.yml.

6. `to_end`

   Флаг, который указывает препроцессору обрезать включенный контент до конца. В противном случае, если указано `from_heading` или `from_id`, препроцессор сокращает включенное содержимое до следующего заголовка того же уровня, что и начальный заголовок, или заголовка, который предшествует начальной привязке.

   Пример:

      ```markdown
      ## Some Heading {#custom_id}

      <anchor>one_more_custom_id</anchor>
      ```markdown

   Здесь `Some Heading {#custom_id}` - это полное содержимое заголовка, `custom_id` - его идентификатор, а `one_more_custom_id` - идентификатор привязки.

7. `wrap_code`

   Атрибут, который позволяет пометить включенный контент как блок кода ограждения или встроенный код, обернув содержимое дополнительными синтаксическими конструкциями Markdown.

   Доступные значения:

   `triple_backticks` — для добавления тройных обратных ссылок, разделенных новыми строками, до и после включенного содержимого;

   `triple_tildas` — аналогично `triple_backticks`, но с использованием тройных тильд;

   `single_backticks` — для добавления одиночных обратных ссылок до и после включенного содержимого без добавления дополнительных новых строк. Обратите внимание, что этот атрибут не влияет на включенный контент.

   Таким образом, если содержимое состоит из нескольких строк и установлен атрибут `wrap_code` со значением `single_backticks`, все новые строки в содержимом будут сохранены. Чтобы выполнить принудительное преобразование нескольких строк в одну, используйте атрибут `inline`.

8. `code_language`

   Язык включенного фрагмента кода, который должен быть дополнительно помечен как блок кода ограждения с помощью атрибута `wrap_code` со значением `triple_backticks` или `triple_tildas`. Обратите внимание, что атрибут `code_language` не действует на встроенный код, который получается при использовании значения `single_backticks`. Значением этого атрибута должна быть строка без пробелов, обычно в нижнем регистре; примеры: `python`, `bash`, `json`.

**Пример использования атрибутов wrap_code и code_language:**

```markdown
<include src="path/to/some/config.yaml"
wrap_code="triple_backticks" code_language="yaml">
</include>
```

#### Дополнительные атрибуты, которые поддерживаются в обеих версиях синтаксиса includes

1. `sethead`

   Уровень самого верхнего заголовка во включенном контенте. Используйте его, чтобы гарантировать, что включенный текст не нарушает порядок заголовков родительского документа:

    ```markdown
    # Заголовок

    ## Подзаголовок

    <include src="other.md" sethead="3"></include>
    ```

2. `nohead`

   Флаг, который указывает препроцессору, что нужно удалить начальный заголовок из включенного содержимого:

    ```markdown
    # My Custom Heading

    <include src="other.md" from_heading="Original Heading" nohead="true"></include>\
    ```

    По умолчанию установлен в `false`.

    По умолчанию начальный заголовок включается в выходные данные, а конечный заголовок - нет. Начальный и конечный якоря никогда не включаются в выходные данные.

3. `inline`

   Флаг, который сообщает препроцессору заменить последовательности пробельных символов многих видов (включая `\r`, `\n` и `\t`) одиночными пробелами (` `) во включенном содержимом, а затем удалить начальные и конечные пробелы.
   Можно использовать в однострочных ячейках таблицы.
   Значение по умолчанию - `false`.

4. `project_root`

   Путь к каталогу верхнего уровня (“root”) проекта, к которому принадлежит включенный файл. Этот параметр может потребоваться для правильного разрешения модификаторов `!path` и `!project_path` во включенном контенте.

    >    **Примечание**
    >
    >    По умолчанию, если включен локальный файл, `project_root` указывает на каталог верхнего уровня текущего проекта Foliant, а если ссылка на файл в удаленном репозитории Git, `project_root` указывает на каталог верхнего уровня этого репозитория.
    В большинстве случаев не нужно переопределять поведение по умолчанию.

Различные варианты могут быть объединены.
Например, можно использовать как `set head`, так и `nonhead`, если нужно включить раздел с пользовательским заголовком.

```markdown
# My Custom Heading

<include src="other.md" from_heading="Original Heading" sethead="1" nohead="true"></include>
```

### Устаревший синтаксис

Устаревший синтаксис сохранен для обеспечения обратной совместимости. Чтобы  использовать, поместите ссылку на включенный файл между тегами `<include>...</include>`.

**Пример включения локального файла:**

```markdown
Tекст взят из другого документа.

<include>path/to/another/document.md</include>
```

Путь может быть либо относительным к обрабатываемому в данный момент файлу markdown, или абсолютным.

Чтобы включить документ из удаленного репозитория Git, поместите его URL-адрес после знака `$` перед путем к документу:

```markdown
Приведенный ниже текст взят из удаленного репозитория.

<include>
    $https://github.com/foo/bar.git$path/to/doc.md
</include>
```

Если псевдоним `alias` репозитория определен в конфигурации проекта, вы можете использовать его вместо URL:

```yaml
- includes:
    aliases:
        foo: https://github.com/foo/bar.git
```

А затем в исходном файле:

```markdown
<include>$foo$path/to/doc.md</include>
```

Вы также можете указать конкретную ветку или версию:

```markdown
Приведенный ниже текст взят из удаленного репозитория с ветки develop.

<include>$foo#develop$path/to/doc.md</include>
```

Чтобы поместить часть документа между двумя заголовками, используйте синтаксис `#Start:Finish` после пути к файлу:

```markdown
Включен контент от “Intro” до “Credits”:

<include>sample.md#Intro:Credits</include>

Включен контент от начала до “Credits”:

<include>sample.md#:Credits</include>

включить содержимое от “Intro” до следующего заголовка того же уровня:

<include>sample.md#Intro</include>
```

В устаревшем синтаксисе могут возникнуть проблемы с использованием символов `$`, `#` и `:` в именах файлов и заголовках, поскольку эти символы могут интерпретироваться как разделители.
